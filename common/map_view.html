<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>åœ°åœ–è¦–åœ–</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    #map {
      width: 100%;
      height: 100vh;
    }
    /* è‡ªå®šç¾©åœ°åœ–æ¨™è¨˜ */
    .custom-marker {
      background: #4CAF50;
      color: white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      border: 3px solid white;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .custom-marker:hover {
      transform: scale(1.15);
    }
    .custom-marker.urgent {
      background: #ef4444;
      animation: pulse 2s infinite;
    }
    .custom-marker.halal {
      background: #10b981;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    /* åœ°åœ–å½ˆå‡ºçª—å£æ¨£å¼ */
    .leaflet-popup-content-wrapper {
      border-radius: 12px;
      padding: 0;
    }
    .leaflet-popup-content {
      margin: 0;
      min-width: 280px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    // é£Ÿç‰©æè´ˆæ•¸æ“šï¼ˆæ¨¡æ“¬ Supabase æ•¸æ“šï¼‰
    const donations = [
      {
        id: 1,
        title: 'æ–°é®®è”¬èœæ²™æ‹‰',
        donor: 'ç¶ è‰²é¤å»³',
        distance: 150,
        expiry: '2å°æ™‚å…§',
        urgent: true,
        tags: ['ç´ é£Ÿ', 'ç´”ç´ '],
        lat: 22.3120,
        lng: 114.2250,
        image: 'https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=300&h=300&fit=crop'
      },
      {
        id: 2,
        title: 'æ¯æ—¥éºµåŒ…',
        donor: 'é™½å…‰çƒ˜ç„™åŠ',
        distance: 300,
        expiry: 'æ˜å¤©',
        urgent: false,
        tags: ['ä¸å«è±¬è‚‰'],
        lat: 22.3140,
        lng: 114.2280,
        image: 'https://images.unsplash.com/photo-1509440159596-0249088772ff?w=300&h=300&fit=crop'
      },
      {
        id: 3,
        title: 'å°åº¦é¦™æ–™é£¯å¥—é¤',
        donor: 'é¦™æ–™å±‹é¤å»³',
        distance: 450,
        expiry: '2å¤©å…§',
        urgent: false,
        tags: ['æ¸…çœŸ Halal'],
        halal: true,
        lat: 22.3100,
        lng: 114.2220,
        image: 'https://images.unsplash.com/photo-1585937421612-70a008356fbe?w=300&h=300&fit=crop'
      },
      {
        id: 4,
        title: 'ç½è£é£Ÿå“åŒ…',
        donor: 'è¬å®¶è¶…å¸‚',
        distance: 600,
        expiry: 'ä¸€é€±å…§',
        urgent: false,
        tags: ['é•·æœŸä¿å­˜'],
        lat: 22.3090,
        lng: 114.2300,
        image: 'https://images.unsplash.com/photo-1628776047620-c8f41409e15a?w=300&h=300&fit=crop'
      }
    ];

    // åˆå§‹åŒ–åœ°åœ–
    function initMap() {
      // è¨­å®šè§€å¡˜å€ä¸­å¿ƒé»ï¼ˆé¦™æ¸¯ï¼‰
      const kwunTong = [22.3120, 114.2250];
      
      const map = L.map('map').setView(kwunTong, 15);

      // æ·»åŠ  OpenStreetMap åœ–å±¤
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap',
        maxZoom: 19
      }).addTo(map);

      // æ·»åŠ ç”¨æˆ¶ä½ç½®æ¨™è¨˜ï¼ˆç¶ è‰²åœ“é»ï¼‰
      L.circle(kwunTong, {
        color: '#4CAF50',
        fillColor: '#4CAF50',
        fillOpacity: 0.3,
        radius: 100
      }).addTo(map).bindPopup('<b>ğŸ“ æ‚¨çš„ä½ç½®</b><br>è§€å¡˜, é¦™æ¸¯');

      // æ·»åŠ é£Ÿç‰©æè´ˆæ¨™è¨˜
      donations.forEach((donation, index) => {
        addDonationMarker(donation, index, map);
      });
    }

    // æ·»åŠ æè´ˆæ¨™è¨˜
    function addDonationMarker(donation, index, map) {
      const iconClass = donation.urgent ? 'custom-marker urgent' : 
                       donation.halal ? 'custom-marker halal' : 
                       'custom-marker';
      
      const customIcon = L.divIcon({
        className: 'custom-div-icon',
        html: `<div class="${iconClass}">${index + 1}</div>`,
        iconSize: [40, 40],
        iconAnchor: [20, 20],
        popupAnchor: [0, -20]
      });

      const marker = L.marker([donation.lat, donation.lng], { icon: customIcon })
        .addTo(map);

      // å‰µå»ºå½ˆå‡ºçª—å£å…§å®¹
      const popupContent = `
        <div style="padding: 12px; min-width: 260px;">
          <div style="display: flex; gap: 8px; margin-bottom: 8px;">
            <img src="${donation.image}" alt="${donation.title}" 
                 style="width: 64px; height: 64px; border-radius: 8px; object-fit: cover;"/>
            <div style="flex: 1;">
              <h3 style="margin: 0; font-size: 14px; font-weight: bold;">${donation.title}</h3>
              <p style="margin: 4px 0 0 0; font-size: 12px; color: #666;">${donation.donor}</p>
              <p style="margin: 4px 0 0 0; font-size: 12px; color: #888;">ğŸ“ ${donation.distance}ç±³</p>
            </div>
          </div>
          ${donation.urgent ? 
            '<p style="margin: 0 0 8px 0; font-size: 12px; font-weight: bold; color: #ef4444;">â° ' + donation.expiry + 'åˆ°æœŸ</p>' : 
            '<p style="margin: 0 0 8px 0; font-size: 12px; color: #666;">åˆ°æœŸ: ' + donation.expiry + '</p>'
          }
          <div style="display: flex; gap: 4px; margin-bottom: 12px; flex-wrap: wrap;">
            ${donation.tags.map(tag => 
              `<span style="font-size: 11px; background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 12px;">${tag}</span>`
            ).join('')}
          </div>
          <button onclick="goToDetail(${donation.id})" 
                  style="width: 100%; background: #4CAF50; color: white; padding: 8px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
            æŸ¥çœ‹è©³æƒ…
          </button>
        </div>
      `;

      marker.bindPopup(popupContent, {
        maxWidth: 300,
        className: 'custom-popup'
      });
    }

    // å‰å¾€è©³æƒ…é ï¼ˆé€šé postMessage é€šçŸ¥çˆ¶é é¢ï¼‰
    function goToDetail(id) {
      // å¦‚æœåœ¨ iframe ä¸­ï¼Œé€šçŸ¥çˆ¶é é¢
      if (window.parent !== window) {
        window.parent.postMessage({ action: 'goToDetail', id: id }, '*');
      } else {
        // å¦‚æœä¸åœ¨ iframe ä¸­ï¼Œç›´æ¥è·³è½‰
        window.location.href = '../recipient/individual_recipient_detail.html';
      }
    }

    // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–åœ°åœ–
    window.addEventListener('load', () => {
      initMap();
    });
  </script>
</body>
</html>

